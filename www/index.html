<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name = "format-detection" content = "telephone=no"/>
		<meta name="viewport" content="width=device-width, initial-scale=1">
        <title>FileTransfer Test</title>
		<script src="js/jquery-1.11.3.min.js"></script>
		<script src="js/console.log.js"></script>
		<script src="js/jquery.md5.js"></script>
		<script src="phonegap.js"></script>
<script>
	function init() {
		console.log("init");
		$('#status').html("Start");
		//alert($.md5 (" String str  d"));
		document.addEventListener("deviceready", onDeviceReady, false);
	}
	
	function onDeviceReady() {
		console.log("onDeviceReady");
		
		if(window.localStorage.getItem('downloaded_files') == null){
			console.log("onDeviceReady 0000000000000000");
			window.localStorage.setItem('downloaded_files',JSON.stringify(["786","110"]));	
		}
		
		console.log("onDeviceReady 1111111");
		
		if(window.localStorage.getItem('download_address') == null){
			console.log("onDeviceReady 22222222222");
			
			window.requestFileSystem(LocalFileSystem.TEMPORARY, 0, 
				function(fs) {
					window.localStorage.setItem('download_address',fs.root.toURL());
					console.log("onDeviceReady 4444444444" + fs.root.toURL());
				}, function(e) {
					alert('failed to get fs');
					alert(JSON.stringify(e));
				}
			);
			console.log(device.platform);
			console.log("onDeviceReady 333333333333");
			if (device.platform == 'iOS')
			{
				console.log("onDeviceReady 666666666666");
				downloadPath = "cdvfile://localhost/persistent/";
				window.localStorage.setItem('download_address',downloadPath);
			}
		}
		
		console.log("window.localStorage.getItem('download_address'):" + window.localStorage.getItem('download_address'));
		console.log("window.localStorage.getItem('downloaded_files'):" + window.localStorage.getItem('downloaded_files'));

	}

	
	
	
	
	function check_download(URL) {
		console.log("check_download");
		var temp_array = JSON.parse(window.localStorage.getItem('downloaded_files'));
		if($.inArray($.md5(URL),temp_array) != -1)
		{
			console.log("check_download true");
			return true;
		}
		else
		{
			console.log("check_download false");
			return false;
		}
	}
	
	function start_download(URL,Extension) {
		console.log("start_download");
		
		var FileTransfer = new FileTransfer();
		var uri = encodeURI(URL);
		downloadPath = window.localStorage.getItem('download_address') + $.md5(URL) + "." + Extension;
		
		console.log("start_download : " + downloadPath);
		
		FileTransfer.onprogress = function(progressEvent) {
			if (progressEvent.lengthComputable) {
				var perc = Math.floor(progressEvent.loaded / progressEvent.total * 100);
				$('#status').html(perc + "% loaded...");
			} else {
				$('#status').html($('#status').html() + ".");
			}
		};
		
		FileTransfer.download(uri, downloadPath, 
			function(entry) {	
				$('#status').html("done");
				console.log("start_download : done");
				temp_array = JSON.parse(window.localStorage.getItem('downloaded_files'));
				temp_array.push($.md5(URL));
				window.localStorage.setItem('downloaded_files',JSON.stringify(temp_array));			
			}, 
			function(error) {
				alert('Crap something went wrong...');	
				alert(JSON.stringify(error));
			},
			true
		);
	}
	
	function play_or_download(URL,Extension) {
		console.log("play_or_download : ");
		downloadPath = window.localStorage.getItem('download_address') + $.md5(URL) + "." + Extension;
		console.log("play_or_download : " + downloadPath);
		if(check_download(URL))
		{
			console.log("play_or_download : check_download");
			var media = new Media(downloadPath, null, function(e) { alert(JSON.stringify(e));});
			media.play();
		}
		else
		{
			console.log("play_or_download : start_download");
			start_download(URL,Extension);
		}
	}
	
	
</script>
    </head>
	<body onload="init();" >

        <div id="content">
            <p>
            Kansas Joe McCoy and Memphis Minnie - "When The Levee Breaks"
            </p>

			
            <p>
            <button id="startDl" onclick="console.log('clicked on play_or_download');play_or_download('http://dlsmgroup.ir/temp/salameee.mp3,'mp3');" >Click to Download and Play</button>
            </p>
        </div>
		
		<div id="status">status....</div>
		<br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>
		<br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>
    </body>
</html>