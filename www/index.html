<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name = "format-detection" content = "telephone=no"/>
		<meta name="viewport" content="width=device-width, initial-scale=1">
        <title>FileTransfer Test</title>
		<script src="js/jquery-1.11.3.min.js"></script>
		<script src="phonegap.js"></script>
<script>
	var buttomDom;
	var statusDom;
	var fileSystem;
	
	function init() {
		$('#status').html("Start");
		document.addEventListener("deviceready", onDeviceReady, false);
	}
	
	function onDeviceReady() {
	  
		//step one is to request a file system	
		window.requestFileSystem(LocalFileSystem.TEMPORARY, 0, 
			function(fs) {
				fileSystem = fs;
				alert("1:" + fileSystem.root.fullPath);
				buttonDom = document.querySelector('#startDl');
				buttonDom.addEventListener('touchend', startDl, false);
				buttonDom.removeAttribute("disabled");
		
			}, function(e) {
				alert('failed to get fs');
				alert(JSON.stringify(e));
			});
	}

	function startDl() {
		buttonDom.setAttribute("disabled","disabled");
		
		var ft = new FileTransfer();
		var uri = encodeURI("http://archive.org/download/Kansas_Joe_Memphis_Minnie-When_Levee_Breaks/Kansas_Joe_and_Memphis_Minnie-When_the_Levee_Breaks.mp3");
		
		alert("2:" + fileSystem.root.fullPath);
		var downloadPath = fileSystem.root.fullPath + "/download.mp3";
		if ( device.platform == 'iOS' ){//Android,iOS,win7=WinCE,win8=Win32NT
			//downloadPath = "/android_asset/www/" + "/download.mp3";
			downloadPath = "cdvfile://localhost/persistent/" + "/download.mp3";
		}

		ft.onprogress = function(progressEvent) {
			if (progressEvent.lengthComputable) {
				var perc = Math.floor(progressEvent.loaded / progressEvent.total * 100);
				$('#status').html(perc + "% loaded...");
			} else {
				//if(statusDom.innerHTML == "") {
				//	$('#status').html("Loading");
				//} else {
					$('#status').html($('#status').html() + ".");
				//}
			}
		};
							
		ft.download(uri, downloadPath, 
		function(entry) {	
			$('#status').html("done");
			if ( device.platform == 'iOS' ){//Android,iOS,win7=WinCE,win8=Win32NT
				//downloadPath = "/android_asset/www/" + "/download.mp3";
				downloadPath = "cdvfile://localhost/persistent/" + "/download.mp3";
			}
			else
				downloadPath = "/android_asset/www/" + "/download.mp3";
				//downloadPath = "cdvfile://localhost/persistent/" + "/download.mp3";
			}
			var media = new Media(downloadPath, null, function(e) { alert(JSON.stringify(e));});
			media.play();
			
		}, 
		function(error) {
			alert('Crap something went wrong...');	
			alert(JSON.stringify(error));
		});
			
		
	}
</script>
    </head>
	<body onload="init();" >

        <div id="content">
            <p>
            Kansas Joe McCoy and Memphis Minnie - "When The Levee Breaks"
            </p>

			
            <p>
            <button id="startDl" disabled>Click to Download and Play</button>
            </p>
        </div>
		
		<div id="status">status....</div>
    </body>
</html>